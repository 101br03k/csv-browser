<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>CSV Browser</title>
    <meta name="description" content="A powerful CSV Browser that allows you to upload, view, sort, filter, and analyze your CSV data in a user-friendly interface.">
    <!-- Open Graph Tags -->
    <meta property="og:title" content="CSV Browser - Easy CSV Data Exploration">
    <meta property="og:description" content="Upload, sort, filter, and analyze your CSV data with our intuitive browser-based CSV Browser.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%233B82F6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' /%3E%3C/svg%3E">
    <link rel="stylesheet" href="index.css">
    
  </head>
  <body>
    <div class="header">
      <span class="header-title">
        <svg width="24" height="24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        CSV Browser
      </span>
      <div style="display: flex; gap: 0.5rem;">
        <button id="downloadBtn" class="download-btn" disabled>Download</button>
        <button id="uploadAnotherBtn" class="download-btn" style="display:none;">Upload another CSV</button>
      </div>
    </div>
    <div class="card" id="uploadCard">
      <div id="uploadArea" class="upload-area" tabindex="0">
        <div style="font-size:2rem; margin-bottom:0.5rem;">‚¨ÜÔ∏è</div>
        <div>
          Drag and drop your CSV file here, or click this area to <span id="browseLink" class="browse-link">browse</span>.
        </div>
        <input id="csvInput" type="file" name="csvfile" accept=".csv" required style="display:none;">
      </div>
    </div>

    <div id="controls-container" class="controls-bar" style="margin-bottom:0;"></div>
    <div id="table-scroll-wrapper" style="overflow-x:auto; width:100%;">
      <div id="table-container"></div>
    </div>
    <div class="footer">
      <a href="https://github.com/101br03k/csv-browser">CSV Browser</a> | Made with <span style="color:#3b82f6;">React</span>
    </div>
    <script>
      let columns = [];
      let colVisibility = {};
      let rows = [];
      // Pagination state
      let rowsPerPage = 10;
      let currentPage = 1;

      // Drag and drop upload logic
      const uploadCard = document.getElementById('uploadCard');
      const uploadArea = document.getElementById('uploadArea');
      const csvInput = document.getElementById('csvInput');
      const browseLink = document.getElementById('browseLink');
      const downloadBtn = document.getElementById('downloadBtn');
      const uploadAnotherBtn = document.getElementById('uploadAnotherBtn');

      // Keep track of whether the Columns & Order dropdown should stay open
      let controlsDropdownOpen = false;

      // Single document click handler: close the dropdown when clicking outside
      document.addEventListener('click', (event) => {
        const dropdown = document.querySelector('.controls-dropdown');
        if (!dropdown) {
          controlsDropdownOpen = false;
          return;
        }
        if (!dropdown.contains(event.target)) {
          controlsDropdownOpen = false;
          dropdown.classList.remove('open');
        }
      });

      browseLink.onclick = () => csvInput.click();

      // Make the whole drop zone clickable and focusable
      uploadArea.addEventListener('click', (e) => {
        csvInput.click();
      });
      uploadArea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          csvInput.click();
        }
      });

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          csvInput.files = e.dataTransfer.files;
          handleCSVUpload(csvInput.files[0]);
        }
      });
      csvInput.addEventListener('change', (e) => {
        if (csvInput.files.length) {
          handleCSVUpload(csvInput.files[0]);
        }
      });

      function handleCSVUpload(file) {
        const formData = new FormData();
        formData.append('csvfile', file);
        fetch('/upload', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            rows = data.rows;
            if (!rows.length) {
              columns = [];
              colVisibility = {};
              renderControls();
              renderTable();
              downloadBtn.disabled = true;
              uploadCard.style.display = '';
              uploadAnotherBtn.style.display = 'none';
              return;
            }
            columns = Object.keys(rows[0]);
            colVisibility = {};
            columns.forEach(col => colVisibility[col] = true);
            renderControls();
            renderTable();
            downloadBtn.disabled = false;
            uploadCard.style.display = 'none';
            uploadAnotherBtn.style.display = '';
          });
      }

      uploadAnotherBtn.onclick = function() {
        // Reset state and show upload area again
        columns = [];
        colVisibility = {};
        rows = [];
        renderControls();
        renderTable();
        uploadCard.style.display = '';
        uploadAnotherBtn.style.display = 'none';
        downloadBtn.disabled = true;
        csvInput.value = '';
      };

      // Persistent renderControls() (keeps dropdown DOM node)
      function renderControls() {
        const container = document.getElementById('controls-container');
        if (!columns.length) {
          container.innerHTML = '';
          return;
        }

        // Ensure left and right wrappers exist and are persistent
        let left = container.querySelector('.controls-left');
        let right = container.querySelector('.controls-right');
        if (!left) {
          left = document.createElement('div');
          left.className = 'controls-left';
          left.style.display = 'flex';
          left.style.gap = '0.5rem';
          container.appendChild(left);
        }
        if (!right) {
          right = document.createElement('div');
          right.className = 'controls-right';
          right.style.marginLeft = 'auto';
          right.style.display = 'flex';
          right.style.alignItems = 'center';
          right.style.gap = '0.5rem';
          container.appendChild(right);
        }

        // Dropdown: create once and then reuse its list element
        let dropdown = left.querySelector('.controls-dropdown');
        if (!dropdown) {
          dropdown = document.createElement('div');
          dropdown.className = 'controls-dropdown';

          const btn = document.createElement('button');
          btn.className = 'controls-dropdown-btn';
          btn.textContent = 'Columns & Order';
          btn.type = 'button';
          btn.onclick = (e) => {
            e.stopPropagation();
            controlsDropdownOpen = !controlsDropdownOpen;
            dropdown.classList.toggle('open', controlsDropdownOpen);
          };

          const content = document.createElement('div');
          content.className = 'controls-dropdown-content';
          const list = document.createElement('div');
          list.className = 'controls-dropdown-list';
          content.appendChild(list);

          dropdown.appendChild(btn);
          dropdown.appendChild(content);
          left.appendChild(dropdown);
        }

        // Apply open state
        dropdown.classList.toggle('open', controlsDropdownOpen);

        // Update the list of columns (only this node is replaced)
        const list = dropdown.querySelector('.controls-dropdown-list');
        list.innerHTML = '';
        columns.forEach((col, idx) => {
          const pill = document.createElement('span');
          pill.className = 'col-pill';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = !!colVisibility[col];
          checkbox.onchange = (e) => {
            e.stopPropagation();
            colVisibility[col] = checkbox.checked;
            controlsDropdownOpen = true;
            renderControls();
            renderTable();
          };
          pill.appendChild(checkbox);

          pill.appendChild(document.createTextNode(' ' + col));

          const leftBtn = document.createElement('button');
          leftBtn.type = 'button';
          leftBtn.title = 'Move up';
          leftBtn.setAttribute('aria-label', 'Move up');
          leftBtn.className = 'col-btn';
          leftBtn.disabled = idx === 0;
          leftBtn.innerHTML = '‚Üë';
          leftBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (idx > 0) {
              [columns[idx - 1], columns[idx]] = [columns[idx], columns[idx - 1]];
              controlsDropdownOpen = true;
              renderControls();
              renderTable();
            }
          };
          pill.appendChild(leftBtn);

          const rightBtn = document.createElement('button');
          rightBtn.type = 'button';
          rightBtn.title = 'Move down';
          rightBtn.setAttribute('aria-label', 'Move down');
          rightBtn.className = 'col-btn';
          rightBtn.disabled = idx === columns.length - 1;
          rightBtn.innerHTML = '‚Üì';
          rightBtn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (idx < columns.length - 1) {
              [columns[idx + 1], columns[idx]] = [columns[idx], columns[idx + 1]];
              controlsDropdownOpen = true;
              renderControls();
              renderTable();
            }
          };
          pill.appendChild(rightBtn);

          list.appendChild(pill);
        });

        // Rows per page: create or update the select element
        let rppWrapper = left.querySelector('.controls-rpp');
        if (!rppWrapper) {
          rppWrapper = document.createElement('div');
          rppWrapper.className = 'controls-rpp';
          const rppLabel = document.createElement('label');
          rppLabel.textContent = 'Rows:';
          rppLabel.style.marginRight = '0.35rem';
          rppLabel.style.fontSize = '0.95rem';
          rppLabel.style.color = '#334155';
          const rppSelect = document.createElement('select');
          rppSelect.className = 'rpp-select';
          [5,10,25,50,100].forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.textContent = n;
            if (n === rowsPerPage) opt.selected = true;
            rppSelect.appendChild(opt);
          });
          rppSelect.onchange = (e) => {
            rowsPerPage = parseInt(rppSelect.value, 10) || 10;
            currentPage = 1;
            renderTable();
          };
          rppWrapper.appendChild(rppLabel);
          rppWrapper.appendChild(rppSelect);
          left.appendChild(rppWrapper);
        } else {
          const rppSelect = rppWrapper.querySelector('.rpp-select');
          if (rppSelect) rppSelect.value = String(rowsPerPage);
        }
      }

      // Helper to render pagination controls into the .controls-right element
      function renderPaginationControls(totalRows) {
        const right = document.querySelector('#controls-container .controls-right');
        if (!right) return;
        right.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
        if (totalPages <= 1) return;

        // Page info: "Showing X‚ÄìY of Z"
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = Math.min(totalRows, startIdx + rowsPerPage);
        const info = document.createElement('span');
        info.className = 'page-info';
        info.textContent = `Showing ${startIdx + 1}‚Äì${endIdx} of ${totalRows}`;
        right.appendChild(info);

        const prev = document.createElement('button');
        prev.type = 'button';
        prev.className = 'page-btn';
        prev.textContent = '‚óÄ';
        prev.disabled = currentPage <= 1;
        prev.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
        right.appendChild(prev);

        const pageSelect = document.createElement('select');
        pageSelect.className = 'page-select';
        for (let p = 1; p <= totalPages; p++) {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = `Page ${p}`;
          if (p === currentPage) opt.selected = true;
          pageSelect.appendChild(opt);
        }
        pageSelect.onchange = (e) => {
          currentPage = parseInt(pageSelect.value, 10) || 1;
          renderTable();
        };
        right.appendChild(pageSelect);

        const next = document.createElement('button');
        next.type = 'button';
        next.className = 'page-btn';
        next.textContent = '‚ñ∂';
        next.disabled = currentPage >= totalPages;
        next.onclick = () => { if (currentPage < totalPages) { currentPage++; renderTable(); } };
        right.appendChild(next);
      }

      function renderTable() {
        const container = document.getElementById('table-container');
        const scrollWrapper = document.getElementById('table-scroll-wrapper');
        if (!rows.length) {
          container.innerHTML = `
            <div class="table-card">
              <div class="no-data">
                <div class="no-data-icon">üìÑ</div>
                <div style="font-weight:600;font-size:1.1em;">No data to display</div>
                <div style="font-size:0.98em; margin-top:0.25em;">Upload a CSV file to get started</div>
              </div>
            </div>
          `;
          scrollWrapper.style.overflowX = 'auto';
          return;
        }
        const visibleCols = columns.filter(col => colVisibility[col]);
        if (!visibleCols.length) {
          container.innerHTML = `
            <div class="table-card">
              <em>No columns visible</em>
            </div>
          `;
          scrollWrapper.style.overflowX = 'auto';
          return;
        }
        // Compute pagination
        const totalRows = rows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = startIdx + rowsPerPage;
        const pageRows = rows.slice(startIdx, endIdx);

        let html = `<div class="table-card" style="padding:0; box-shadow:none; border:none;"><table style="min-width:900px;"><thead><tr>`;
        visibleCols.forEach(key => {
          html += `<th>${key}</th>`;
        });
        html += `</tr></thead><tbody>`;
        pageRows.forEach(row => {
          html += `<tr>`;
          visibleCols.forEach(col => {
            html += `<td>${row[col]}</td>`;
          });
          html += `</tr>`;
        });
        html += `</tbody></table></div>`;
        container.innerHTML = html;
        scrollWrapper.style.overflowX = 'auto';
        // Render pagination controls (if needed)
        renderPaginationControls(totalRows);
      }

      // Download CSV logic
      downloadBtn.onclick = function() {
        if (!rows.length) return;
        const visibleCols = columns.filter(col => colVisibility[col]);
        let csv = visibleCols.join(',') + '\n';
        rows.forEach(row => {
          csv += visibleCols.map(col => `"${(row[col] || '').replace(/"/g, '""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'data.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
      };
    </script>
  </body>
</html>
